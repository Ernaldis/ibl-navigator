# docker-compose up -d --build
version: '2.4'
services:     
  iblapi:
    build: ./backend
    image: iblapi:v1.0
    environment:
    - DJ_USER=maho
    - DJ_HOST=datajoint.internationalbrainlab.org
    env_file: ./.env
    # volumes:
    #   - ./backend:/src/iblapi
    # ports:
    #   - "5000:5000"
    entrypoint: ["/src/iblapi/run-ibl-api.prod.sh"]
    # entrypoint: ["/src/iblapi/run-ibl-api.dev.sh", "development"]
    networks:
      - main
  ibl-navigator:
    build: ./ibl-frontend
    image: ibl-navigator:v1.0
    environment:
    - PROD_NODE_API=http://localhost:3333/api
    - PROD_NODE_BACKEND=http://localhost:3333
    # - DEV_NODE_API=http://localhost:9000/api
    # - DEV_NODE_BACKEND=http://localhost:9000
    ports:
      - "8080:8080"
    networks:
      - main
    depends_on:
      ibl-node-server:
        condition: service_healthy
      iblapi:
        condition: service_healthy
  ibl-node-server:
    build: ./node_server
    image: ibl-node-server:v1.0
    environment:
    - NODE_ENV=development
    - DEMO_USERNAME=ibluser
    - PY_BACKEND=http://iblapi:5000
    env_file: .env
    # volumes:
    #   - ./node_server:/src
    ports:
      - "3333:3333"
    networks:
      - main
networks:
    main:
        ipam:
            driver: default
            config:
                - subnet: 10.28.0.0/16


# services:
  # iblapi-dj:
  #   build: ./backend
  #   env_file: ./backend/.env
  #   volumes:
  #     - ./backend/notebooks:/notebooks
  #     - ./backend:/src/iblapi
  #   ports:
  #     - "8888:8888"
  #   links:
  #     - iblapi